"use client";

import { useEffect, useMemo, useState } from "react";
import Papa from "papaparse";
import {
  ResponsiveContainer,
  ComposedChart,
  Bar,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  Legend,
  CartesianGrid,
} from "recharts";

type TabKey = "summary" | "structure" | "keyword";

type Row = {
  date: string;
  source: string;
  impression: number;
  click: number;
  cost: number;
  conversion: number;
  revenue: number;
  campaign?: string;
};

function safeDiv(a: number, b: number) {
  return b ? a / b : 0;
}

function KRW(n: number) {
  return Math.round(n).toLocaleString() + "ì›";
}

const TrendCell = ({ v, digits = 1 }: { v: number | null; digits?: number }) => {
  if (v === null || !isFinite(v)) return <span className="text-gray-400">-</span>;

  const up = v > 0;
  const down = v < 0;

  const arrow = up ? "â–²" : down ? "â–¼" : "â€¢";
  const color = up ? "text-red-600" : down ? "text-blue-600" : "text-gray-500";

  return (
    <span className={`inline-flex items-center gap-1 font-semibold ${color}`}>
      <span className="text-xs">{arrow}</span>
      <span>{(v * 100).toFixed(digits)}%</span>
    </span>
  );
};
function FilterBtn({
  active,
  onClick,
  children,
}: {
  active: boolean;
  onClick: () => void;
  children: React.ReactNode;
}) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={[
        "px-4 py-2 rounded-xl border text-sm font-semibold transition",
        "border-orange-900/40",
        active
          ? "bg-orange-700 text-white shadow"
          : "bg-orange-600 text-white/90 hover:bg-orange-700",
      ].join(" ")}
    >
      {children}
    </button>
  );
}
// â­ ì„  ê·¸ë˜í”„ ë§ˆì§€ë§‰ ì  â†’ í™”ì‚´í‘œ
const ArrowDot = (props: any) => {
  const { cx, cy, index, data } = props;

  // ë§ˆì§€ë§‰ ì ë§Œ í™”ì‚´í‘œ í‘œì‹œ
  if (index !== data.length - 1) return null;

  return (
    <text
      x={cx}
      y={cy}
      dy={4}
      dx={8}
      fill="#ef4444"
      fontSize={20}
    >
      â†’
    </text>
  );
};

export default function Page() {
  const [rows, setRows] = useState<Row[]>([]);
  type MonthKey = "all" | string; // "YYYY-MM" ë˜ëŠ” "all"
  const [selectedMonth, setSelectedMonth] = useState<MonthKey>("all");
  type FilterKey = "month" | "week" | "device" | "channel" | null;
const [filterKey, setFilterKey] = useState<FilterKey>(null);

type WeekKey = "all" | string;
const [selectedWeek, setSelectedWeek] = useState<WeekKey>("all");


// ë²„íŠ¼ ëˆ„ë¥´ë©´ ì—´ê³ /ë‹«ëŠ” í† ê¸€
const toggleFilter = (k: Exclude<FilterKey, null>) => {
  setFilterKey((prev) => (prev === k ? null : k));
};
  const [tab, setTab] = useState<TabKey>("summary");

const monthOptions = useMemo(() => {
  const set = new Set<string>();
  for (const r of rows) {
    // r.dateê°€ "YYYY-MM-DD" ë¼ê³  ê°€ì •
    const d = new Date(r.date);
    if (Number.isNaN(d.getTime())) continue;

    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    set.add(`${y}-${m}`); // âœ… ë„ˆ MonthKeyê°€ "YYYY-MM" í˜•íƒœë¼ì„œ ì´ê±¸ë¡œ ë§ì¶¤
  }
  return Array.from(set).sort().reverse(); // ìµœì‹  ì›”ì´ ì•ìœ¼ë¡œ
}, [rows]);

  const monthLabel =
  selectedMonth === "all"
    ? "ì „ì²´"
    : `${selectedMonth.slice(0, 4)}ë…„ ${Number(selectedMonth.slice(5, 7))}ì›”`;
    const monthLabelOf = (m: string) =>
      `${m.slice(0, 4)}ë…„ ${Number(m.slice(5, 7))}ì›”`;

    useEffect(() => {
    fetch("/data/acc_001.csv")
      .then((res) => res.text())
      .then((csv) => {
        const parsed = Papa.parse<Row>(csv, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
        });
        setRows(parsed.data);
      });
  }, []);

  function monthKeyOf(d: Date) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  return `${y}-${m}`; // YYYY-MM
}

// ì£¼ì°¨ ê°ì²´ì—ì„œ YYYY-MM ì¶”ì¶œ (weekKeyê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©)
const monthKeyFromWeek = (w: any) => {
  // weekKeyê°€ "YYYY-MM-..." í˜•íƒœë©´ ì• 7ìë¦¬ ì‚¬ìš©
  if (w?.weekKey && /^\d{4}-\d{2}/.test(w.weekKey)) return w.weekKey.slice(0, 7);

  // labelì´ "2022ë…„ 7ì›” 4ì£¼ì°¨" ê°™ì€ í˜•íƒœë©´ íŒŒì‹±
  const m = String(w?.label || "").match(/(\d{4})ë…„\s*(\d{1,2})ì›”/);
  if (!m) return "";
  const yy = m[1];
  const mm = String(Number(m[2])).padStart(2, "0");
  return `${yy}-${mm}`;
};

const periodText = useMemo(() => {
  // rowsê°€ ë¹„ì–´ìˆìœ¼ë©´ í‘œì‹œ X
  if (!rows?.length) return "";

  // selectedMonth === "all" ì´ë©´: rows ì „ì²´ ê¸°ê°„
  if (selectedMonth === "all") {
    const ds = (rows as any[])
      .map((r) => parseDateLoose(r.date))
      .filter(Boolean) as Date[];
    if (!ds.length) return "";
    const min = new Date(Math.min(...ds.map((d) => d.getTime())));
    const max = new Date(Math.max(...ds.map((d) => d.getTime())));
    const fmt = (d: Date) =>
      `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, "0")}.${String(
        d.getDate()
      ).padStart(2, "0")}`;
    return `${fmt(min)} ~ ${fmt(max)}`;
  }

  // selectedMonthê°€ "YYYY-MM" í˜•íƒœë¼ê³  ê°€ì •
  const [yy, mm] = selectedMonth.split("-").map(Number);
  if (!yy || !mm) return "";

  const start = new Date(yy, mm - 1, 1);
  const end = new Date(yy, mm, 0); // í•´ë‹¹ ì›” ë§ˆì§€ë§‰ë‚ 

  const fmt = (d: Date) =>
    `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, "0")}.${String(
      d.getDate()
    ).padStart(2, "0")}`;

  return `${fmt(start)} ~ ${fmt(end)}`;
}, [rows, selectedMonth]);


const months = useMemo(() => {
  const set = new Set<string>();
  for (const r of rows as any[]) {
    const d = parseDateLoose(r.date);
    if (!d) continue;
    set.add(monthKeyOf(d));
  }
  // ìµœì‹  ì›”ì´ ì•ì— ì˜¤ë„ë¡
  return Array.from(set).sort((a, b) => b.localeCompare(a));
}, [rows]);

const byWeek = useMemo(() => {
  // 1) rowsì—ì„œ ë‚ ì§œ íŒŒì‹± ê°€ëŠ¥í•œ ê²ƒë§Œ
  const valid = (rows as any[])
    .map((r) => {
      const d = parseDateLoose(r.date);
      if (!d) return null;
      return { ...r, __date: d };
    })
    .filter(Boolean) as any[];

  if (valid.length === 0) return [];

  // 2) ê°€ì¥ ìµœì‹  ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ "ìµœê·¼ 5ì£¼" ë²”ìœ„ ì¡ê¸°
  const maxTime = Math.max(...valid.map((r) => r.__date.getTime()));
  const maxDate = new Date(maxTime);
  const latestWeekStart = startOfWeekMonday(maxDate);

  const weekStarts: Date[] = [];
  for (let i = 4; i >= 0; i--) {
    const ws = new Date(latestWeekStart);
    ws.setDate(ws.getDate() - i * 7);
    weekStarts.push(ws);
  }

  const key = (d: Date) => startOfWeekMonday(d).toISOString().slice(0, 10);

  const map = new Map<
    string,
    { weekKey: string; label: string; cost: number; revenue: number; roas: number }
  >();

  // 3) 5ì£¼ ë°”ìŠ¤ì¼“ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘ê¸°(ëˆ„ë½ ì£¼ë„ 0ìœ¼ë¡œ í‘œì‹œ)
  for (const ws of weekStarts) {
    const k = ws.toISOString().slice(0, 10);
    map.set(k, {
  weekKey: k,
  label: monthWeekLabelRule(ws),
  impressions: 0,
  clicks: 0,
  cost: 0,
  conversions: 0,
  revenue: 0,
});

  }

  // 4) ì§‘ê³„
  for (const r of valid) {
    const k = key(r.__date);
    if (!map.has(k)) continue; // ìµœê·¼ 5ì£¼ ë°–ì´ë©´ ë¬´ì‹œ

    const cur = map.get(k)!;
    cur.impressions += Number(r.impressions ?? 0) || 0;
    cur.clicks += Number(r.clicks ?? 0) || 0;
    cur.cost += Number(r.cost ?? 0) || 0;
    cur.conversions += Number(r.conversions ?? 0) || 0;
    cur.revenue += Number(r.revenue ?? 0) || 0;
    map.set(k, cur);
  }

  // 5) ROAS ê³„ì‚° + ë°°ì—´ë¡œ ì •ë ¬
  const arr = Array.from(map.values()).sort((a, b) => b.weekKey.localeCompare(a.weekKey)); // ë‚´ë¦¼ì°¨ìˆœ(ìµœê·¼ ë¨¼ì €)

return arr.map((w) => ({
  ...w,
  ctr: safeDiv(w.clicks, w.impressions),
  cpc: safeDiv(w.cost, w.clicks),
  cvr: safeDiv(w.conversions, w.clicks),
  cpa: safeDiv(w.cost, w.conversions),
  roas: safeDiv(w.revenue, w.cost),
}));
}, 
[rows]);

// âœ… "ì£¼ì°¨" ë¼ë²¨ë§Œ ë‚¨ê¸°ê¸° (5ì›” ê°™ì€ ì›” ë¼ë²¨ ì œê±°)
const byWeekOnly = useMemo(
  () => byWeek.filter((w: any) => String(w.label).includes("ì£¼ì°¨")),
  [byWeek]
);

// âœ… ì°¨íŠ¸ Xì¶• ì¢Œ/ìš° ë’¤ì§‘ê¸°ìš© (ì›ë³¸ ë°°ì—´ ë³´ì¡´)
const byWeekChart = useMemo(() => [...byWeekOnly].reverse(), [byWeekOnly]);


const lastWeek = byWeek[0];
const prevWeek = byWeek[1];

function diffPct(a: number, b: number) {
  if (!b) return 0;
  return (a - b) / b;
}

// âœ… ì£¼ì°¨ ì„ íƒ ì‹œ: í•´ë‹¹ ì£¼ì°¨ê°€ ì†í•œ "ì›”"ë§Œ í™œì„±ì²˜ëŸ¼ ë³´ì´ê²Œ í•  ë•Œ ì“°ëŠ” ê°’
const selectedWeekMonthKey = useMemo(() => {
  if (selectedWeek === "all") return "";
  const w = byWeekOnly.find((x: any) => x.weekKey === selectedWeek);
  return w ? monthKeyFromWeek(w) : "";
}, [selectedWeek, byWeekOnly]);

// âœ… ì£¼ì°¨ íŒ¨ë„ì—ì„œ "ì§€ê¸ˆ ì„ íƒ ê°€ëŠ¥í•œ ì£¼ì°¨" (ì›” í•„í„°ê°€ ìˆìœ¼ë©´ ê·¸ ì›” ì£¼ì°¨ë§Œ í™œì„±)
const enabledWeekKeySet = useMemo(() => {
  const set = new Set<string>();
  byWeekOnly.forEach((w: any) => {
    const wk = w.weekKey;
    if (!wk) return;

    // ì›”ì´ ì„ íƒë˜ì—ˆë‹¤ë©´: ê·¸ ì›”ì— ì†í•œ ì£¼ì°¨ë§Œ í™œì„±
    if (selectedMonth !== "all") {
      if (monthKeyFromWeek(w) === selectedMonth) set.add(wk);
      return;
    }

    // ì›”ì´ allì´ê³ , ì£¼ì°¨ë§Œ ì„ íƒë˜ì—ˆë‹¤ë©´: ì„ íƒ ì£¼ì°¨ì˜ ì›”ì— ì†í•œ ì£¼ì°¨ë§Œ í™œì„±(=ì—‘ì…€ ëŠë‚Œ)
    if (selectedWeek !== "all") {
      if (monthKeyFromWeek(w) === selectedWeekMonthKey) set.add(wk);
      return;
    }

    // ë‘˜ ë‹¤ allì´ë©´: ì „ë¶€ í™œì„±
    set.add(wk);
  });
  return set;
}, [byWeekOnly, selectedMonth, selectedWeek, selectedWeekMonthKey]);

// âœ… ì›” íŒ¨ë„ì—ì„œ "ì§€ê¸ˆ í™œì„±ì²˜ëŸ¼ ë³´ì—¬ì¤„ ì›”" (ì£¼ì°¨ë§Œ ì„ íƒì´ë©´ ê·¸ ì›”ë§Œ í™œì„±)
const enabledMonthKeySet = useMemo(() => {
  const set = new Set<string>();

  // ì›”ì´ ì§ì ‘ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ê·¸ ì›”ë§Œ í™œì„± í‘œì‹œ
  if (selectedMonth !== "all") {
    set.add(selectedMonth);
    return set;
  }

  // ì›”ì€ allì¸ë° ì£¼ì°¨ê°€ ì„ íƒë˜ì–´ ìˆìœ¼ë©´: ê·¸ ì£¼ì°¨ì˜ ì›”ë§Œ í™œì„± í‘œì‹œ
  if (selectedWeek !== "all" && selectedWeekMonthKey) {
    set.add(selectedWeekMonthKey);
    return set;
  }

  // ì•„ë¬´ê²ƒë„ ì„ íƒ ì—†ìœ¼ë©´ ì „ë¶€ í™œì„± í‘œì‹œ
  months.forEach((m: string) => set.add(m));
  return set;
}, [months, selectedMonth, selectedWeek, selectedWeekMonthKey]);


const filteredRows = useMemo(() => {
  if (selectedMonth === "all") return rows;
  return (rows as any[]).filter((r) => {
    const d = parseDateLoose(r.date);
    if (!d) return false;
    return monthKeyOf(d) === selectedMonth;
  });
}, [rows, selectedMonth]);

  const totals = useMemo(() => {
    const sum = (key: keyof Row) =>
      filteredRows.reduce((acc, cur) => acc + (Number(cur[key]) || 0), 0);

    const impressions = sum("impressions");
    const clicks = sum("clicks");
    const cost = sum("cost");
    const conversions = sum("conversions");
    const revenue = sum("revenue");

    return {
      impressions,
      clicks,
      cost,
      conversions,
      revenue,
      ctr: safeDiv(clicks, impressions),
      cpc: safeDiv(cost, clicks),
      cvr: safeDiv(conversions, clicks),
      cpa: safeDiv(cost, conversions),
      roas: safeDiv(revenue, cost),
    };
  }, [filteredRows]);

  const bySource = useMemo(() => {
  // group key: platform ìš°ì„ , ì—†ìœ¼ë©´ soucrce/sourceë„ fallback
  const keyOf = (r: any) =>
    String(r.platform ?? r.soucrce ?? r.source ?? "unknown").toLowerCase();

  const map = new Map<
    string,
    {
      source: string;
      impressions: number;
      clicks: number;
      cost: number;
      conversions: number;
      revenue: number;
    }
  >();

  for (const r of filteredRows as any[]) {
    const k = keyOf(r);

    const impressions = Number(r.impressions ?? r.impression ?? 0) || 0;
    const clicks = Number(r.clicks ?? r.click ?? 0) || 0;
    const cost = Number(r.cost ?? 0) || 0;
    const conversions = Number(r.conversions ?? r.conversion ?? 0) || 0;
    const revenue = Number(r.revenue ?? 0) || 0;

    const cur =
      map.get(k) ??
      { source: k, impressions: 0, clicks: 0, cost: 0, conversions: 0, revenue: 0 };

    cur.impressions += impressions;
    cur.clicks += clicks;
    cur.cost += cost;
    cur.conversions += conversions;
    cur.revenue += revenue;

    map.set(k, cur);
  }

  const arr = Array.from(map.values());
  // ë¹„ìš© í° ìˆœìœ¼ë¡œ ì •ë ¬(ì›í•˜ë©´ ë°”ê¿”ë„ ë¨)
  arr.sort((a, b) => b.cost - a.cost);

  return arr.filter((r) => r.source !== "unknown").map((r) => ({
    ...r,
    ctr: safeDiv(r.clicks, r.impressions),
    cpc: safeDiv(r.cost, r.clicks),
    cvr: safeDiv(r.conversions, r.clicks),
    cpa: safeDiv(r.cost, r.conversions),
    roas: safeDiv(r.revenue, r.cost),
  }));
}, [filteredRows]);

function parseDateLoose(s: any): Date | null {
  if (!s) return null;
  // "2022.4.26" ê°™ì€ í¬ë§· ëŒ€ì‘
  const str = String(s).trim();
  const normalized = str.replace(/\./g, "-"); // 2022-4-26
  const d = new Date(normalized);
  return isNaN(d.getTime()) ? null : d;
}

function startOfWeekMonday(d: Date): Date {
  const x = new Date(d);
  x.setHours(0, 0, 0, 0);
  const day = x.getDay(); // 0=Sun ... 6=Sat
  const diff = (day === 0 ? -6 : 1) - day; // Monday ê¸°ì¤€
  x.setDate(x.getDate() + diff);
  return x;
}

function fmtMMDD(d: Date) {
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${m}.${dd}`;
}
function week1StartOfMonth(year: number, monthIndex0: number) {
  const firstDay = new Date(year, monthIndex0, 1);
  firstDay.setHours(0, 0, 0, 0);

  const dow = firstDay.getDay(); // 0=ì¼ ... 6=í† 
  const includeFirstWeek = dow >= 1 && dow <= 4; // ì›”~ëª©
  const firstWeekStart = startOfWeekMonday(firstDay);

  const ws = new Date(firstWeekStart);
  if (!includeFirstWeek) ws.setDate(ws.getDate() + 7);
  return ws;
}

function addDays(d: Date, days: number) {
  const x = new Date(d);
  x.setDate(x.getDate() + days);
  return x;
}

function startOfWeekMon(d: Date) {
  const x = new Date(d);
  const day = x.getDay(); // 0 Sun, 1 Mon ...
  const diff = (day + 6) % 7; // Mon=0 ... Sun=6
  x.setDate(x.getDate() - diff);
  x.setHours(0, 0, 0, 0);
  return x;
}

// âœ… ë„¤ê°€ ë§í•œ ë£° ë°˜ì˜ ë¼ë²¨ ìƒì„±ê¸°
function monthWeekLabelRule(ws: Date) {
  const we = addDays(ws, 6); // week end (Sun)

  // 1) ê¸°ë³¸ì€ wsì˜ ë‹¬
  let baseY = ws.getFullYear();
  let baseM = ws.getMonth();

  // 2) "ë‹¤ìŒë‹¬ 1ì¼"ì´ ì´ë²ˆ ì£¼ì— í¬í•¨ë˜ê³ , ê·¸ ìš”ì¼ì´ ì›”~ëª©ì´ë©´ â†’ ê¸°ì¤€ë‹¬ì„ ë‹¤ìŒë‹¬ë¡œ
  const nextMonthFirst = new Date(ws.getFullYear(), ws.getMonth() + 1, 1);
  if (nextMonthFirst >= ws && nextMonthFirst <= we) {
    const dow = nextMonthFirst.getDay(); // 1~4 => Mon~Thu
    if (dow >= 1 && dow <= 4) {
      baseY = nextMonthFirst.getFullYear();
      baseM = nextMonthFirst.getMonth();
    }
  }

  // 3) ê¸°ì¤€ë‹¬ì˜ 1ì£¼ì°¨ ì‹œì‘(ì›”ìš”ì¼)ì„ ê³„ì‚°
  const monthFirst = new Date(baseY, baseM, 1);
  const monthFirstDow = monthFirst.getDay(); // 0 Sun
  const week1Start = startOfWeekMon(monthFirst);

  // ë„¤ ë£°: 1ì¼ì´ ê¸ˆ/í† /ì¼ì´ë©´ ê·¸ ì£¼ëŠ” "ì „ì›” ë§ˆì§€ë§‰ ì£¼" ì·¨ê¸‰
  // => ì¦‰, ê·¸ ë‹¬ì˜ 1ì£¼ì°¨ëŠ” ë‹¤ìŒì£¼(ë‹¤ìŒ ì›”ìš”ì¼)ë¶€í„° ì‹œì‘
  const effectiveWeek1Start =
    monthFirstDow === 5 || monthFirstDow === 6 || monthFirstDow === 0
      ? addDays(week1Start, 7)
      : week1Start;

  // 4) wsê°€ ê¸°ì¤€ë‹¬ì˜ ëª‡ ì£¼ì°¨ì¸ì§€ ê³„ì‚°
  const diffWeeks = Math.floor(
    (startOfWeekMon(ws).getTime() - effectiveWeek1Start.getTime()) / (7 * 24 * 60 * 60 * 1000)
  );
  const weekNo = diffWeeks + 1;

  // ì•ˆì „ì¥ì¹˜(ìŒìˆ˜ë©´ ì „ì›”ë¡œ ì˜ëª» ì¡íŒ ì¼€ì´ìŠ¤): ìµœì†Œ 1ì£¼ì°¨ë¡œ
  const safeWeekNo = weekNo < 1 ? 1 : weekNo;

  return `${baseY}ë…„ ${baseM + 1}ì›” ${safeWeekNo}ì£¼ì°¨`;
}


const monthScopeRows = useMemo(() => {
  // 1) ì „ì²´ë©´ rows ê·¸ëŒ€ë¡œ
  if (selectedMonth === "all") return rows;

  // 2) ì„ íƒì›” í¬í•¨ ìµœê·¼ 3ê°œì›” ë²”ìœ„ ìƒì„±
  const [yy, mm] = selectedMonth.split("-").map(Number); // âœ… "-" ì„
  const start = new Date(yy, mm - 1 - 2, 1); // ì„ íƒì›” -2ê°œì›” 1ì¼
  const end = new Date(yy, mm, 1);           // ì„ íƒì›” ë‹¤ìŒë‹¬ 1ì¼ (exclusive)

  return (rows as any[]).filter((r) => {
    const d = parseDateLoose(r.date);
    if (!d) return false;
    return d >= start && d < end;
  });
}, [rows, selectedMonth]);

const byMonth = useMemo(() => {
  const map = new Map<
    string,
    {
      month: string; // YYYY-MM
      impressions: number;
      clicks: number;
      cost: number;
      conversions: number;
      revenue: number;
    }
  >();

  for (const r of monthScopeRows as any[]) {
    const d = parseDateLoose(r.date);
    if (!d) continue;

    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;

    if (!map.has(key)) {
      map.set(key, {
        month: key,
        impressions: 0,
        clicks: 0,
        cost: 0,
        conversions: 0,
        revenue: 0,
      });
    }

    const cur = map.get(key)!;
    const imp = Number((r.impressions ?? r.impression ?? 0));
    const clk = Number((r.clicks ?? r.click ?? 0));
    const cst = Number((r.cost ?? 0));
    const cv  = Number((r.conversions ?? r.conversion ?? 0));
    const rev = Number((r.revenue ?? 0));

    cur.impressions += isFinite(imp) ? imp : 0;
    cur.clicks += isFinite(clk) ? clk : 0;
    cur.cost += isFinite(cst) ? cst : 0;
    cur.conversions += isFinite(cv) ? cv : 0;
    cur.revenue += isFinite(rev) ? rev : 0;

  }

  // ìµœì‹  ì›”ì´ ìœ„ë¡œ ì˜¤ê²Œ ì •ë ¬ í›„ ìµœê·¼ 3ê°œì›”ë§Œ
  const arr = Array.from(map.values())
    .sort((a, b) => b.month.localeCompare(a.month))
    .slice(0, 3);

  return arr.map((m) => ({
    ...m,
    ctr: safeDiv(m.clicks, m.impressions),
    cpc: safeDiv(m.cost, m.clicks),
    cvr: safeDiv(m.conversions, m.clicks),
    cpa: safeDiv(m.cost, m.conversions),
    roas: safeDiv(m.revenue, m.cost),
  }));
},
[monthScopeRows]);


  return (
  <main className="p-8">
    <div className="mx-auto w-full max-w-[1400px]">
      {/* ì œëª© */}
      <div className="mb-10 text-center">
        <h1 className="text-3xl font-semibold tracking-tight">
          ë„¤ì´ì²˜ì»¬ë ‰ì…˜ ì˜¨ë¼ì¸ê´‘ê³  ë³´ê³ ì„œ
        </h1>

        {/* ë°‘ì¤„: ì´ wrapper í­ì„ 100%ë¡œ ë¨¹ìŒ */}
        <div className="mt-4 border-t border-gray-400"></div>
        <div className="mt-1 border-t border-gray-300"></div>
      </div>

{/* ğŸ”¥ ìƒë‹¨ í•„í„° + íƒ­ ì˜ì—­ */}
<div className="flex items-center justify-between mb-8">

  {/* ğŸŸ  ì™¼ìª½: í•„í„° ë²„íŠ¼ + ë“œë¡­ë‹¤ìš´ ê¸°ì¤€ì (ì—‘ì…€ ëŠë‚Œ) */}
<div className="relative inline-block">
  <div className="flex gap-2">
    <FilterBtn active={filterKey === "month"} onClick={() => toggleFilter("month")}>
      ì›”
    </FilterBtn>
    <FilterBtn active={filterKey === "week"} onClick={() => toggleFilter("week")}>
      ì£¼ì°¨
    </FilterBtn>
    <FilterBtn active={filterKey === "device"} onClick={() => toggleFilter("device")}>
      ê¸°ê¸°
    </FilterBtn>
    <FilterBtn active={filterKey === "channel"} onClick={() => toggleFilter("channel")}>
      ì±„ë„
    </FilterBtn>
  </div>

{periodText && (
  <div className="mt-3 mb-2 text-sm text-gray-600">
    ê¸°ê°„: <span className="font-semibold text-gray-900">{periodText}</span>
  </div>
)}

  {/* âœ… ì›” ë“œë¡­ë‹¤ìš´ íŒ¨ë„ (ë²„íŠ¼ ì•„ë˜ì— ê²¹ì³ì„œ ëœ¸) */}
  {filterKey === "month" && (
    <div className="absolute left-0 top-full mt-2 z-50 w-[520px] rounded-xl border bg-white shadow-lg p-3">
      <div className="flex flex-wrap gap-2 max-h-[220px] overflow-auto">
        <button
          type="button"
          onClick={() => {
            setSelectedMonth("all");
            setFilterKey(null); // ì„ íƒ í›„ íŒ¨ë„ ë‹«ê¸°
          }}
          className={[
            "px-3 py-1 rounded-lg border text-sm font-semibold",
            selectedMonth === "all" ? "bg-orange-700 text-white border-orange-700" : "bg-white text-orange-700 border-orange-300",
          ].join(" ")}
        >
          ì „ì²´
        </button>

     {monthOptions.map((m) => {
  const disabled = !enabledMonthKeySet.has(m);

  return (
    <button
      key={m}
      type="button"
      onClick={() => {
        setSelectedMonth(m);
        setFilterKey(null);
      }}
      className={[
        "px-3 py-1 rounded-lg border text-sm font-semibold transition",
        disabled ? "opacity-40" : "",
        disabled ? "cursor-not-allowed" : "",

        // ì„ íƒëœ ì›”
        selectedMonth === m
          ? "bg-orange-700 text-white border-orange-700"

          // ë¹„í™œì„± (íšŒìƒ‰)
          : disabled
          ? "bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed"

          // ê¸°ë³¸ ìƒíƒœ
          : "bg-white text-orange-700 border-orange-300 hover:bg-orange-50",
      ].join(" ")}
    >
      {monthLabelOf(m)}
    </button>
  );
})}

      </div>
    </div>
  )}
</div>

{filterKey === "week" && (
  <div className="mt-2 flex flex-wrap gap-2">
    {/* ì „ì²´ */}
    <button
      type="button"
      onClick={() => setSelectedWeek("all")}
      className={[
        "px-3 py-1 rounded-lg border text-sm font-semibold",
        selectedWeek === "all"
          ? "bg-orange-700 text-white border-orange-700"
          : "bg-white text-orange-700 border-orange-700/40",
      ].join(" ")}
    >
      ì „ì²´
    </button>

    {byWeekOnly.map((w: any) => {
      const wk = w.weekKey;
      const disabled = !enabledWeekKeySet.has(wk);

      // ë¼ë²¨ í˜•ì‹: "YYYYë…„ MMì›” Oì£¼ì°¨"
      const label = String(w.label); // ì´ë¯¸ ì´ í˜•íƒœë©´ ê·¸ëŒ€ë¡œ ì¨ë„ OK

      return (
        <button
          key={wk}
          type="button"
          onClick={() => {
            setSelectedMonth(m);
            setFilterKey(null);
          }}

          className={[
            "px-3 py-1 rounded-lg border text-sm font-semibold transition",
            disabled
              ? "bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed"
              : selectedWeek === wk
              ? "bg-orange-700 text-white border-orange-700"
              : "bg-white text-orange-700 border-orange-700/40 hover:bg-orange-50",
          ].join(" ")}
        >
          {label}
        </button>
      );
    })}
  </div>
)}


  {/* ğŸ”µ ì˜¤ë¥¸ìª½: ìš”ì•½ / êµ¬ì¡° / í‚¤ì›Œë“œ */}
  <div className="flex gap-3">
    <button
      onClick={() => setTab("summary")}
      className={`px-5 py-2 rounded-xl border text-sm font-semibold transition
        ${tab === "summary"
          ? "bg-black text-white border-black"
          : "bg-white text-black border-gray-300 hover:bg-gray-100"}`}
    >
      ìš”ì•½
    </button>

    <button
      onClick={() => setTab("structure")}
      className={`px-5 py-2 rounded-xl border text-sm font-semibold transition
        ${tab === "structure"
          ? "bg-black text-white border-black"
          : "bg-white text-black border-gray-300 hover:bg-gray-100"}`}
    >
      êµ¬ì¡°
    </button>

    <button
      onClick={() => setTab("keyword")}
      className={`px-5 py-2 rounded-xl border text-sm font-semibold transition
        ${tab === "keyword"
          ? "bg-black text-white border-black"
          : "bg-white text-black border-gray-300 hover:bg-gray-100"}`}
    >
      í‚¤ì›Œë“œ
    </button>
  </div>
</div>


{tab === "summary" && (
<>
 {/* KPI ê·¸ë¦¬ë“œ */}
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
      <KPI title="ë…¸ì¶œ" value={totals.impressions.toLocaleString()} />
      <KPI title="í´ë¦­" value={totals.clicks.toLocaleString()} />
      <KPI title="CTR" value={(totals.ctr * 100).toFixed(2) + "%"} />
      <KPI title="CPC" value={KRW(totals.cpc)} />
      <KPI title="ë¹„ìš©" value={KRW(totals.cost)} />

      <KPI title="ì „í™˜ìˆ˜" value={totals.conversions.toLocaleString()} />
      <KPI title="CVR" value={(totals.cvr * 100).toFixed(2) + "%"} />
      <KPI title="ì „í™˜ë§¤ì¶œ" value={KRW(totals.revenue)} />
      <KPI title="CPA" value={KRW(totals.cpa)} />
      <KPI title="ROAS" value={(totals.roas * 100).toFixed(1) + "%"} />
    </div>

 {/* ì›”ë³„ í‘œ */}
    <section className="mt-10">
  <h2 className="text-lg font-semibold mb-3">ì›”ë³„ ì„±ê³¼ (ìµœê·¼ 3ê°œì›”)</h2>

  <div className="overflow-auto border rounded-xl">
    <table className="w-full text-sm">
      <thead className="bg-gray-50 text-gray-600">
        <tr>
          <th className="text-left p-3">Month</th>
          <th className="text-right p-3">Impr</th>
          <th className="text-right p-3">Clicks</th>
          <th className="text-right p-3">CTR</th>
          <th className="text-right p-3">CPC</th>
          <th className="text-right p-3">Cost</th>
          <th className="text-right p-3">Conv</th>
          <th className="text-right p-3">CVR</th>
          <th className="text-right p-3">CPA</th>
          <th className="text-right p-3">Revenue</th>
          <th className="text-right p-3">ROAS</th>
        </tr>
      </thead>

      <tbody>
        {/* âœ… 1í–‰: ì¦ê° (ìµœê·¼ì›” vs ì „ì›”) */}
        {byMonth.length >= 2 && (() => {
          const last = byMonth[0];   // ìµœê·¼ì›”
          const prev = byMonth[1];   // ì „ì›”

          const diff = (a: number, b: number) => a - b;
          const diffPct = (a: number, b: number) => (b === 0 ? null : (a - b) / b);

          const fmtPct = (x: number | null, digits = 1) =>
            x === null ? "-" : `${(x * 100).toFixed(digits)}%`;

          const fmtNum = (x: number) => Math.round(x).toLocaleString();
          const fmtKRW = (x: number) => `${Math.round(x).toLocaleString()}ì›`;

          return (
            <tr className="border-t bg-gray-100 font-semibold">
              <td className="p-3">ì¦ê° (ìµœê·¼ì›”-ì „ì›”)</td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.impressions, prev.impressions)} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.clicks, prev.clicks)} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.ctr, prev.ctr)} digits={2} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.cpc, prev.cpc)} digits={2} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.cost, prev.cost)} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.conversions, prev.conversions)} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.cvr, prev.cvr)} digits={2} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.cpa, prev.cpa)} digits={2} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.revenue, prev.revenue)} /></td>
          <td className="p-3 text-right"><TrendCell v={diffPct(last.roas, prev.roas)} digits={2} /></td>

            </tr>
          );
        })()}

        {/* âœ… 2~4í–‰: ìµœê·¼ 3ê°œì›” */}
        {byMonth.map((m) => (
          <tr key={m.month} className="border-t">
            <td className="p-3 font-medium">{m.month}</td>

            <td className="p-3 text-right">{m.impressions.toLocaleString()}</td>
            <td className="p-3 text-right">{m.clicks.toLocaleString()}</td>

            <td className="p-3 text-right">{(m.ctr * 100).toFixed(2)}%</td>
            <td className="p-3 text-right">{KRW(m.cpc)}</td>

            <td className="p-3 text-right">{KRW(m.cost)}</td>
            <td className="p-3 text-right">{m.conversions.toLocaleString()}</td>

            <td className="p-3 text-right">{(m.cvr * 100).toFixed(2)}%</td>
            <td className="p-3 text-right">{KRW(m.cpa)}</td>

            <td className="p-3 text-right">{KRW(m.revenue)}</td>
            <td className="p-3 text-right">{(m.roas * 100).toFixed(1)}%</td>
  </tr>
))}

      </tbody>
    </table>
  </div>
</section>

 {/* ì£¼ê°„ í‘œ */}
<section className="mt-10">
  <h2 className="text-lg font-semibold mb-3">
    ì£¼ì°¨ë³„ ì„±ê³¼ (ìµœê·¼ 5ì£¼)
  </h2>

  <div className="overflow-auto border rounded-xl">
    <table className="w-full text-sm">
      <thead className="bg-gray-50">
        <tr>
          <th className="text-left p-3">Week</th>
          <th className="text-right p-3">Impr</th>
          <th className="text-right p-3">Clicks</th>
          <th className="text-right p-3">CTR</th>
          <th className="text-right p-3">CPC</th>
          <th className="text-right p-3">Cost</th>
          <th className="text-right p-3">Conv</th>
          <th className="text-right p-3">CVR</th>
          <th className="text-right p-3">CPA</th>
          <th className="text-right p-3">Revenue</th>
          <th className="text-right p-3">ROAS</th>
        </tr>
      </thead>

      <tbody>
        {/* ğŸ”¥ ì¦ê° í–‰ */}
        {lastWeek && prevWeek && (
          <tr className="bg-gray-100 font-medium">
            <td className="p-3">ì¦ê°(ìµœê·¼ì£¼-ì „ì£¼)</td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.impressions, prevWeek.impressions)} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.clicks, prevWeek.clicks)} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.ctr, prevWeek.ctr)} digits={2} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.cpc, prevWeek.cpc)} digits={2} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.cost, prevWeek.cost)} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.conversions, prevWeek.conversions)} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.cvr, prevWeek.cvr)} digits={2} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.cpa, prevWeek.cpa)} digits={2} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.revenue, prevWeek.revenue)} />
            </td>
            <td className="p-3 text-right">
              <TrendCell v={diffPct(lastWeek.roas, prevWeek.roas)} digits={2} />
            </td>
          </tr>
        )}

        {/* ğŸ”¥ ìµœê·¼ 5ì£¼ */}
        {byWeekOnly.map((w) => (
          <tr key={w.weekKey} className="border-t">
            <td className="p-3 font-medium">{w.label}</td>
            <td className="p-3 text-right">{w.impressions.toLocaleString()}</td>
            <td className="p-3 text-right">{w.clicks.toLocaleString()}</td>
            <td className="p-3 text-right">{(w.ctr * 100).toFixed(2)}%</td>
            <td className="p-3 text-right">{KRW(w.cpc)}</td>
            <td className="p-3 text-right">{KRW(w.cost)}</td>
            <td className="p-3 text-right">{w.conversions.toLocaleString()}</td>
            <td className="p-3 text-right">{(w.cvr * 100).toFixed(2)}%</td>
            <td className="p-3 text-right">{KRW(w.cpa)}</td>
            <td className="p-3 text-right">{KRW(w.revenue)}</td>
            <td className="p-3 text-right">{(w.roas * 100).toFixed(1)}%</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</section>

  {/* ì£¼ê°„ ì°¨íŠ¸ */}
    <section className="mt-10">
  <h2 className="text-lg font-semibold mb-3">ìµœê·¼ 5ì£¼ ì£¼ê°„ ì„±ê³¼</h2>

  {/* ê°€ë¡œ ê½‰ + ë†’ì´ (í‘œì˜ 1.5ë°° ëŠë‚Œìœ¼ë¡œ ì¼ë‹¨ 420px ì¶”ì²œ) */}
  <div className="w-full h-[420px] border rounded-xl p-4">
    <ResponsiveContainer width="100%" height="100%">
      <ComposedChart data={byWeekChart} margin={{ top: 10, right: 30, left: 10, bottom: 0 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="label" />
        <YAxis
  yAxisId="left"
  tick={{ fontSize: 10 }}   // â† ê¸€ì”¨ 2ë‹¨ê³„ ì¶•ì†Œ
  width={60}                // â† ìˆ«ì ì—¬ë°± í™•ë³´ (ì„ íƒì´ì§€ë§Œ ì¶”ì²œ)
  tickFormatter={(v) => v.toLocaleString()} // â† ì²œë‹¨ìœ„ ì‰¼í‘œ
/>

        <YAxis
  yAxisId="right"
  orientation="right"
  tick={{ fontSize: 10 }}                 // ê¸€ì”¨ 2ë‹¨ê³„ â†“ ëŠë‚Œ (ê¸°ì¡´ ëŒ€ë¹„ ì‘ê²Œ)
  width={50}                               // ì˜¤ë¥¸ìª½ ìˆ«ì ì˜ì—­ í™•ë³´(ì˜ë¦¼ ë°©ì§€)
  tickFormatter={(v) => `${(Number(v) * 100).toFixed(1)}%`}  // ROASë¥¼ %ë¡œ
/>

        <Tooltip
  formatter={(value: any, name: any, item: any) => {
    const key = item?.dataKey ?? name; // âœ… dataKey ìš°ì„ 

    if (key === "roas") {
      return [`${(Number(value) * 100).toFixed(1)}%`, "ROAS"];
    }

    if (key === "cost") {
      return [`â‚©${Number(value).toLocaleString()}`, "ë¹„ìš©"];
    }

    if (key === "revenue") {
      return [`â‚©${Number(value).toLocaleString()}`, "ì „í™˜ë§¤ì¶œ"];
    }

    return [value, name];
  }}
/>


        <Legend />

        {/* ëˆ„ì  ì„¸ë¡œí˜• ë§‰ëŒ€(ë¹„ìš©+ì „í™˜ë§¤ì¶œ) */}
        {/* ëˆ„ì  ë§‰ëŒ€: ë¹„ìš©(ì£¼í™©) + ì „í™˜ë§¤ì¶œ(í•˜ëŠ˜) */}
<Bar
  yAxisId="left"
  dataKey="cost"
  stackId="a"
  name="ë¹„ìš©"
  fill="#F59E0B"   // ì£¼í™©
/>
<Bar
  yAxisId="left"
  dataKey="revenue"
  stackId="a"
  name="ì „í™˜ë§¤ì¶œ"
  fill="#38BDF8"   // í•˜ëŠ˜ìƒ‰
/>

{/* ROAS ë¼ì¸: êµµì€ ë¹¨ê°• + í™”ì‚´í‘œ */}
<Line
  yAxisId="right"
  type="monotone"
  dataKey="roas"
  name="ROAS"
  stroke="#EF4444"     // ë¹¨ê°„ìƒ‰
  strokeWidth={3}      // êµµê²Œ
  dot={{
    stroke: "#EF4444",
    strokeWidth: 2,
    fill: "#EF4444",
    r: 5,
    // â–¼ í™”ì‚´í‘œ ëŠë‚Œ (ì‚¼ê°í˜•)
    // RechartsëŠ” ê¸°ë³¸ dot shapeë¥¼ SVG pathë¡œ ëŒ€ì²´ ê°€ëŠ¥
    // ì‚¼ê°í˜• í¬ì¸íŠ¸
    className: "roas-arrow-dot",
  }}
  activeDot={{
    r: 7,
  }}
/>

      </ComposedChart>
    </ResponsiveContainer>
  </div>
</section>

  {/* ì†ŒìŠ¤ë³„ í‘œ */}
    <section className="mt-10">
  <h2 className="text-lg font-semibold mb-3">ì†ŒìŠ¤ë³„ ìš”ì•½</h2>

  <div className="overflow-auto border rounded-xl">
    <table className="w-full text-sm">
      <thead className="bg-gray-50 text-gray-600">
        <tr>
          <th className="text-left p-3">Source</th>
          <th className="text-right p-3">Impr</th>
          <th className="text-right p-3">Clicks</th>
          <th className="text-right p-3">CTR</th>
          <th className="text-right p-3">CPC</th>
          <th className="text-right p-3">Cost</th>
          <th className="text-right p-3">Conv</th>
          <th className="text-right p-3">CVR</th>
          <th className="text-right p-3">CPA</th>
          <th className="text-right p-3">Revenue</th>
          <th className="text-right p-3">ROAS</th>
        </tr>
      </thead>

      <tbody>
        {bySource.map((r) => (
          <tr key={r.source} className="border-t">
            <td className="p-3 font-medium">{r.source}</td>
            <td className="p-3 text-right">{r.impressions.toLocaleString()}</td>
            <td className="p-3 text-right">{r.clicks.toLocaleString()}</td>
            <td className="p-3 text-right">{(r.ctr * 100).toFixed(2)}%</td>
            <td className="p-3 text-right">{KRW(r.cpc)}</td>
            <td className="p-3 text-right">{KRW(r.cost)}</td>
            <td className="p-3 text-right">{r.conversions.toLocaleString()}</td>
            <td className="p-3 text-right">{(r.cvr * 100).toFixed(2)}%</td>
            <td className="p-3 text-right">{KRW(r.cpa)}</td>
            <td className="p-3 text-right">{KRW(r.revenue)}</td>
            <td className="p-3 text-right">{(r.roas * 100).toFixed(1)}%</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</section>
</>
)}

</div>
  </main>
);
}

function KPI({ title, value }: { title: string; value: string }) {
  return (
    <div className="border rounded-xl p-4 min-w-[160px]">
      <div className="text-sm text-gray-500 whitespace-nowrap">{title}</div>
      <div className="text-2xl font-bold mt-1 whitespace-nowrap">{value}</div>
    </div>
  );
}
